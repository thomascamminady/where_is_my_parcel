<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Add an ant path animation to a line</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.12.0/mapbox-gl.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZHJ0YyIsImEiOiJjbDdlaHc5ZmYwMGljM3Zxd281NG1ldnY0In0.nNyxKCk9bl2KwcVQbRIiVA';

    const coordinates = [
      [12.374733, 51.340632, ],
      [12.374733, 51.340632, ],
      [12.374733, 51.340632, ],
      [12.374733, 51.340632, ],
      [12.374733, 51.340632, ],
      [12.374733, 51.340632, ],
      [12.374733, 51.340632, ],
      [12.374733, 51.340632, ],
      [-118.242766, 34.053691, ],
      [-118.242766, 34.053691, ],
      [-118.242766, 34.053691, ],
      [-122.419906, 37.779026, ],
      [-122.419906, 37.779026, ],
      [-121.4939328, 38.581021],
      [-121.4939328, 38.581021],
      [-121.4939328, 38.581021],
      [-84.51246, 39.101454],
    ].reverse()
    const geojson = {
      'type': 'FeatureCollection',
      'features': [{
        'type': 'Feature',
        'properties': {},
        'geometry': {
          'coordinates': coordinates,
          'type': 'LineString'
        }
      }]
    };

    const map = new mapboxgl.Map({
      container: 'map', // container ID
      // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
      //style: 'mapbox://styles/mapbox/light-v11', // style URL
      style: 'mapbox://styles/mapbox/streets-v11', // style URL
      //center: [-73.9709, 40.6712], // starting position [lng, lat]
      zoom: 1.773, // starting zoom
      // set bounds to limit the map to a certain area
      // Set bounding box as the maximum bounds of the coordinates
      bounds: coordinates.reduce((bounds, coord) => bounds.extend(coord), new mapboxgl.LngLatBounds(coordinates[0],
        coordinates[0]))


    });

    map.on('load', () => {
      map.addSource('line', {
        type: 'geojson',
        data: geojson
      });

      // Add a marker for every coordinate along the line
      // Have every marker use the latitude and longitude
      // as text in the marker
      geojson.features[0].geometry.coordinates.forEach((coord, index) => {
        const marker = new mapboxgl.Marker({
          color: 'blue'
        }).setLngLat(coord).setPopup(new mapboxgl.Popup({
          offset: 25
        }).setHTML('<h3>' + coord[0] + ', ' + coord[1] + '</h3>')).addTo(map);
      });




      // add a line layer without line-dasharray defined to fill the gaps in the dashed line
      map.addLayer({
        type: 'line',
        source: 'line',
        id: 'line-background',
        paint: {
          'line-color': 'blue',
          'line-width': 6,
          'line-opacity': 0.4
        }
      });

      // add a line layer with line-dasharray set to the first value in dashArraySequence
      map.addLayer({
        type: 'line',
        source: 'line',
        id: 'line-dashed',
        paint: {
          'line-color': 'blue',
          'line-width': 6,
          'line-dasharray': [0, 4, 3]
        }




      });

      // technique based on https://jsfiddle.net/2mws8y3q/
      // an array of valid line-dasharray values, specifying the lengths of the alternating dashes and gaps that form the dash pattern
      const dashArraySequence = [
        [0, 4, 3],
        [0.5, 4, 2.5],
        [1, 4, 2],
        [1.5, 4, 1.5],
        [2, 4, 1],
        [2.5, 4, 0.5],
        [3, 4, 0],
        [0, 0.5, 3, 3.5],
        [0, 1, 3, 3],
        [0, 1.5, 3, 2.5],
        [0, 2, 3, 2],
        [0, 2.5, 3, 1.5],
        [0, 3, 3, 1]
      ];

      let step = 0;

      function animateDashArray(timestamp) {
        // Update line-dasharray using the next value in dashArraySequence. The
        // divisor in the expression `timestamp / 50` controls the animation speed.
        const newStep = parseInt(
          (timestamp / 250) % dashArraySequence.length
        );

        if (newStep !== step) {
          map.setPaintProperty(
            'line-dashed',
            'line-dasharray',
            dashArraySequence[step]
          );
          step = newStep;
        }

        // Request the next frame of the animation.
        requestAnimationFrame(animateDashArray);
      }

      // start the animation
      animateDashArray(0);
    });

  </script>

</body>

</html>
